user  angie;
worker_processes  auto;
worker_rlimit_nofile 65536;

error_log  /var/log/angie/error.log notice;
pid        /run/angie.pid;

events {
    worker_connections  65536;
}

http {
    include       /etc/angie/mime.types;
    default_type  application/octet-stream;

    # Логирование
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    log_format extended '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" rt="$request_time" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        'h="$host" sn="$server_name" ru="$request_uri" u="$uri" '
                        'ucs="$upstream_cache_status" ua="$upstream_addr" us="$upstream_status" '
                        'uct="$upstream_connect_time" urt="$upstream_response_time"';

    access_log  /var/log/angie/access.log  extended;

    keepalive_timeout  65;
    types_hash_max_size 2048;

    # Proxy cache (зона и путь)
    proxy_cache_path /var/www/cache levels=1:2 keys_zone=one:100m inactive=24h max_size=2g;
    proxy_cache_key "$scheme$host$request_uri";

    # Глобальная компрессия (gzip)
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml application/font-ttf;

    # Адаптивная доставка изображений — map обязателен в контексте http
    map $http_accept $webp_suffix {
        "~*webp" ".webp";
        default "";
    }
    map $http_accept $avif_suffix {
        "~*avif" ".avif";
        "~*webp" ".webp";
        default "";
    }

    include /etc/angie/http.d/*.conf;
}

