# Определяем переменные через map
map $request_uri $is_image {
    default 0;
    ~^/images/.*\.(jpg|jpeg|png|gif)$ 1;
}

map $request_uri $is_css {
    default 0;
    ~^/assets/css/.*\.css$ 1;
}

map $request_uri $is_js {
    default 0;
    ~^/assets/js/.*\.js$ 1;
}

map $request_uri $is_font {
    default 0;
    ~^/assets/fonts/.*\.(woff2?|ttf|eot|svg|otf)$ 1;
}

map $request_uri $is_sass {
    default 0;
    ~^/assets/sass/.*\.scss$ 1;
}

map $request_uri $is_error {
    default 0;
    ~^/error/ 1;
}

server {
    listen 80;
    server_name static-site.local;

    root /var/www/static_site-252831-96c1e2;
    index index.html;

    access_log /var/log/angie/static_site.log;

    # Главная страница
    location = / {
        add_header X-Page-Type "Main";
        try_files $uri $uri/ =404;
    }

    # Комбинированный location для изображений
    location ~* ^/images/.*\.(jpg|jpeg|png|gif)$ {
        add_header X-Dir "Images";
        if ($is_image) {
            add_header X-Image-Detected "Yes";
        }
        expires 30d;
        access_log off;
        try_files $uri $uri/ =404;
    }

    # CSS
    location ~* ^/assets/css/.*\.css$ {
        add_header Content-Type "text/css";
        if ($is_css) {
            add_header X-CSS-Detected "Yes";
        }
        expires 7d;
        try_files $uri $uri/ =404;
    }

    # JS
    location ~* ^/assets/js/.*\.js$ {
        add_header Content-Type "application/javascript";
        if ($is_js) {
            add_header X-JS-Detected "Yes";
        }
        expires 7d;
        try_files $uri $uri/ =404;
    }

    # Fonts
    location ~* ^/assets/fonts/.*\.(woff2?|ttf|eot|svg|otf)$ {
        add_header Content-Type "application/font";
        if ($is_font) {
            add_header X-Font-Detected "Yes";
        }
        expires 90d;
        try_files $uri $uri/ =404;
    }

    # Sass
    location ~* ^/assets/sass/.*\.scss$ {
        add_header X-Sass "Source";
        if ($is_sass) {
            add_header X-Sass-Detected "Yes";
        }
        expires 1d;
        try_files $uri $uri/ =404;
    }

    # Error
    location /error/ {
        if ($is_error) {
            return 302 /error/index.html;
        }
        try_files $uri $uri/ =404;
    }

    # Внутреннее перенаправление
    location /old-page {
        rewrite ^/old-page$ /new-page.html break;
    }

    # Перманентное перенаправление
    location /moved {
        return 301 /new-location.html;
    }

    error_page 404 /error/index.html;
}
